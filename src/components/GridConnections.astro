---
// Component to draw connection lines between cards in grid view
---

<svg
  id="grid-connections"
  class="grid-connections-svg"
  style="position: absolute; top: 0; left: 0; width: 100%; pointer-events: none; z-index: 0;"
>
</svg>

<script>
  function drawConnections() {
    const svg = document.getElementById('grid-connections');
    if (!svg) {
      console.log('SVG element not found');
      return;
    }

    // Clear existing connections
    svg.innerHTML = '';

    // Get all event cards (use the event-card ID pattern)
    const cards = Array.from(document.querySelectorAll('[id^="event-"]')).filter((el) => {
      // Only include actual event cards (they have rounded-lg class)
      return el.classList.contains('rounded-lg');
    });

    console.log(`Found ${cards.length} event cards`);

    if (cards.length < 2) return;

    // Get the grid container (the parent of the cards)
    const gridContainer = cards[0]?.parentElement;
    if (!gridContainer) {
      console.log('Grid container not found');
      return;
    }

    const gridRect = gridContainer.getBoundingClientRect();
    const wrapperRect = svg.parentElement?.getBoundingClientRect();
    if (!wrapperRect) return;

    // Set SVG height to match grid container
    svg.style.height = `${gridRect.height}px`;
    svg.setAttribute('viewBox', `0 0 ${gridRect.width} ${gridRect.height}`);

    // Draw lines between consecutive cards
    for (let i = 0; i < cards.length - 1; i++) {
      const currentCard = cards[i] as HTMLElement;
      const nextCard = cards[i + 1] as HTMLElement;

      const currentRect = currentCard.getBoundingClientRect();
      const nextRect = nextCard.getBoundingClientRect();

      // Calculate center points relative to grid container
      const x1 = currentRect.left + currentRect.width / 2 - gridRect.left;
      const y1 = currentRect.top + currentRect.height / 2 - gridRect.top;
      const x2 = nextRect.left + nextRect.width / 2 - gridRect.left;
      const y2 = nextRect.top + nextRect.height / 2 - gridRect.top;

      // Create curved path (bezier curve)
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');

      // Control points for smooth curve
      const controlPointOffset = Math.abs(y2 - y1) * 0.5;
      const cx1 = x1;
      const cy1 = y1 + controlPointOffset;
      const cx2 = x2;
      const cy2 = y2 - controlPointOffset;

      const d = `M ${x1} ${y1} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x2} ${y2}`;

      path.setAttribute('d', d);
      path.setAttribute('stroke', '#6366f1'); // indigo-500 for high visibility
      path.setAttribute('stroke-width', '4');
      path.setAttribute('fill', 'none');
      path.setAttribute('opacity', '0.8');
      path.setAttribute('stroke-linecap', 'round');

      svg.appendChild(path);

      // Add arrow at end point
      const arrowSize = 12;
      const angle = Math.atan2(y2 - cy2, x2 - cx2);

      const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
      const arrowPoint1X = x2 - arrowSize * Math.cos(angle - Math.PI / 6);
      const arrowPoint1Y = y2 - arrowSize * Math.sin(angle - Math.PI / 6);
      const arrowPoint2X = x2 - arrowSize * Math.cos(angle + Math.PI / 6);
      const arrowPoint2Y = y2 - arrowSize * Math.sin(angle + Math.PI / 6);

      arrow.setAttribute('points', `${x2},${y2} ${arrowPoint1X},${arrowPoint1Y} ${arrowPoint2X},${arrowPoint2Y}`);
      arrow.setAttribute('fill', '#6366f1'); // indigo-500
      arrow.setAttribute('opacity', '0.9');

      svg.appendChild(arrow);
    }

    console.log(`Drew ${cards.length - 1} connections`);
  }

  // Draw on load
  drawConnections();

  // Redraw on window resize
  let resizeTimeout: NodeJS.Timeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(drawConnections, 100);
  });

  // Redraw on page navigation (for Astro view transitions)
  document.addEventListener('astro:page-load', () => {
    setTimeout(drawConnections, 100);
  });

  // Redraw after view transitions complete
  document.addEventListener('astro:after-swap', () => {
    setTimeout(drawConnections, 100);
  });
</script>

<style>
  .grid-connections-svg {
    transition: opacity 0.3s ease;
  }
</style>
