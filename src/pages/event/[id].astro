---
import eventsDataRaw from '../../../data/events.json';
import { eventsDataSchema } from '../../lib/eventSchema';
import Navbar from '../../components/Navbar.astro';
import BackButton from '../../components/BackButton.astro';
import EventDetailCard from '../../components/EventDetailCard.astro';
import EventNavigation from '../../components/EventNavigation.astro';
import { sortEventsByDelta } from '../../lib/deltaParser';
import { ClientRouter } from 'astro:transitions';
import '../../styles/global.css';

// Parse and validate event data through Zod schema
const eventsData = eventsDataSchema.parse(eventsDataRaw);

// Get the event ID from the URL
const { id } = Astro.params;

// Preserve filter parameters from the URL
const filterParams = Astro.url.search;

// Find the event by ID
const event = eventsData.events.find((e) => e.id === id);

// If event not found, return 404
if (!event) {
  return Astro.redirect('/404');
}

// Get sorted events for navigation
const sortedEvents = sortEventsByDelta(eventsData.events);
const currentIndex = sortedEvents.findIndex((e) => e.id === id);
const prevEvent = currentIndex > 0 ? sortedEvents[currentIndex - 1] : null;
const nextEvent = currentIndex < sortedEvents.length - 1 ? sortedEvents[currentIndex + 1] : null;

// Get marker tag if exists
const markerTag = event.tags.find((tag: string) => tag.startsWith('marker:'));
const markerLabel = markerTag ? markerTag.split(':')[1]?.trim() : null;

// Build marker class
const markerClass = markerLabel
  ? `marker-${markerLabel
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '')}`
  : null;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{event.delta || 'Unknown time'} - We Is Us Event</title>
    <ClientRouter />
  </head>
  <body class="min-h-screen bg-gray-50">
    <Navbar />

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <BackButton href={`/${filterParams || '?showAll=true'}#event-${currentIndex}`} />

      <EventDetailCard
        event={event}
        currentIndex={currentIndex}
        markerLabel={markerLabel}
        markerClass={markerClass}
      />

      <EventNavigation prevEvent={prevEvent} nextEvent={nextEvent} filterParams={filterParams} />
    </main>
  </body>
</html>
