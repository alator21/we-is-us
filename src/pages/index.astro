---
// Load scene data from JSON file
import scenesData from '../../data/scenes.json';
import Navbar from '../components/Navbar.astro';
import { parseFilterParams, hasFilterParams } from '../lib/urlParams';
import '../styles/global.css';

// Helper function to extract episode/season from tags
function getTagValue(tags: string[], key: string): string {
  const tag = tags.find((t) => t.startsWith(`${key}:`));
  return tag ? tag.split(':')[1] || '1' : '1';
}

// Parse and validate filter params from URL
const filterParams = parseFilterParams(Astro.url.searchParams);
const hasFilter = hasFilterParams(Astro.url.searchParams);

// Redirect to filter page if no params
if (!hasFilter) {
  return Astro.redirect('/filter');
}

// Extract validated values
const showAll = filterParams.showAll;
const maxSeason = showAll ? 999 : filterParams.season || 0;
const maxEpisode = showAll ? 999 : filterParams.episode || 0;

// Filter scenes based on user's progress
const filteredScenes = scenesData.scenes.filter((scene) => {
  if (showAll) return true;

  const sceneSeason = parseInt(getTagValue(scene.tags, 'season'));
  const sceneEpisode = parseInt(getTagValue(scene.tags, 'episode'));

  return sceneSeason < maxSeason || (sceneSeason === maxSeason && sceneEpisode <= maxEpisode);
});
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>We Is Us - Timeline Viewer</title>
  </head>
  <body class="min-h-screen bg-gray-50">
    <Navbar />

    <!-- Main Content -->
    <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Page Header -->
      <div class="mb-8 flex justify-between items-center">
        <div>
          <h2 class="text-3xl font-bold text-gray-900 mb-2">Timeline</h2>
          <p class="text-gray-600">Explore the non-linear narrative of the show</p>
        </div>
        <a
          href="/filter"
          class="px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-700 border border-blue-600 rounded-md hover:bg-blue-50 transition-colors"
        >
          Change Filter
        </a>
      </div>

      <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-sm text-blue-800">
          {
            showAll
              ? 'Showing all scenes (no spoiler protection)'
              : `Showing scenes up to Season ${maxSeason}, Episode ${maxEpisode}`
          }
        </p>
      </div>

      <!-- Scenes List -->
      <div class="flex flex-col gap-6">
        {
          filteredScenes.map((scene) => {
            return (
              <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
                <h3 class="text-xl font-semibold text-gray-900 mb-3">Delta: {scene.delta}</h3>
                <p class="text-gray-700 mb-4">{scene.text}</p>
                <div class="flex flex-wrap gap-2">
                  {scene.tags.map((tag) => (
                    <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-medium">
                      {tag}
                    </span>
                  ))}
                </div>
              </div>
            );
          })
        }
      </div>

      {
        filteredScenes.length === 0 && (
          <div class="text-center py-12">
            <p class="text-gray-500 text-lg">No scenes to display with current filter settings.</p>
            <a href="/filter" class="mt-4 inline-block text-blue-600 hover:text-blue-700">
              Change filter settings
            </a>
          </div>
        )
      }
    </main>
  </body>
</html>
