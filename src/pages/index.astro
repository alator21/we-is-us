---
// Load event data from JSON file
import eventsData from '../../data/events.json';
import Navbar from '../components/Navbar.astro';
import { parseFilterParams, hasFilterParams } from '../lib/urlParams';
import { sortEventsByDelta, calculateTimeDiff } from '../lib/deltaParser';
import { ClientRouter } from 'astro:transitions';
import '../styles/global.css';

// Helper function to extract episode/season from tags
function getTagValue(tags: string[], key: string): string {
  const tag = tags.find((t) => t.startsWith(`${key}:`));
  return tag ? tag.split(':')[1] || '1' : '1';
}

// Parse and validate filter params from URL
const filterParams = parseFilterParams(Astro.url.searchParams);
const hasFilter = hasFilterParams(Astro.url.searchParams);

// Redirect to filter page if no params
if (!hasFilter) {
  return Astro.redirect('/filter');
}

// Extract validated values
const showAll = filterParams.showAll;
const maxSeason = showAll ? 999 : filterParams.season || 0;
const maxEpisode = showAll ? 999 : filterParams.episode || 0;
const layout = filterParams.layout || 'list';

// Get list of revealed event IDs from validated params
const revealedIds = new Set(filterParams.reveal || []);

// Helper to build URL with current params
function buildUrl(overrides: Record<string, string> = {}): string {
  const params = new URLSearchParams();
  if (showAll) {
    params.set('showAll', 'true');
  } else {
    params.set('season', maxSeason.toString());
    params.set('episode', maxEpisode.toString());
  }
  if (revealedIds.size > 0) {
    params.set('reveal', Array.from(revealedIds).join(','));
  }
  params.set('layout', layout);

  // Apply overrides
  Object.entries(overrides).forEach(([key, value]) => {
    params.set(key, value);
  });

  return `/?${params.toString()}`;
}

// Mark events as spoilers based on user's progress
const eventsWithSpoilerFlag = eventsData.events.map((event) => {
  if (showAll) {
    return { ...event, isSpoiler: false };
  }

  const eventSeason = parseInt(getTagValue(event.tags, 'season'));
  const eventEpisode = parseInt(getTagValue(event.tags, 'episode'));

  const isSpoiler = !(
    eventSeason < maxSeason ||
    (eventSeason === maxSeason && eventEpisode <= maxEpisode)
  );

  return { ...event, isSpoiler };
});

// Sort events chronologically by delta
const sortedEvents = sortEventsByDelta(eventsWithSpoilerFlag);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>We Is Us - Timeline Viewer</title>
    <ClientRouter />
  </head>
  <body class="min-h-screen bg-gray-50">
    <Navbar />

    <!-- Main Content -->
    <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Page Header -->
      <div class="mb-8 flex justify-between items-center">
        <div>
          <h2 class="text-3xl font-bold text-gray-900 mb-2">Timeline</h2>
        </div>
        <div class="flex items-center gap-3">
          <!-- Layout Toggle -->
          <div class="flex bg-gray-100 rounded-lg p-1 gap-1">
            <a
              href={buildUrl({ layout: 'list' })}
              class:list={[
                'px-3 py-1.5 text-sm font-medium rounded-md transition-colors',
                layout === 'list'
                  ? 'bg-white text-gray-900 shadow-sm'
                  : 'text-gray-600 hover:text-gray-900',
              ]}
            >
              List
            </a>
            <a
              href={buildUrl({ layout: 'grid' })}
              class:list={[
                'px-3 py-1.5 text-sm font-medium rounded-md transition-colors',
                layout === 'grid'
                  ? 'bg-white text-gray-900 shadow-sm'
                  : 'text-gray-600 hover:text-gray-900',
              ]}
            >
              Grid
            </a>
          </div>
          <a
            href="/filter"
            class="px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-700 border border-blue-600 rounded-md hover:bg-blue-50 transition-colors"
          >
            Change Filter
          </a>
        </div>
      </div>

      <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-sm text-blue-800">
          {
            showAll
              ? 'Showing all events (no spoiler protection)'
              : `Spoiler protection active: Events beyond Season ${maxSeason}, Episode ${maxEpisode} are blurred`
          }
        </p>
      </div>

      <!-- Events List -->
      <div
        class:list={[
          layout === 'grid'
            ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4'
            : 'flex flex-col',
        ]}
      >
        {
          sortedEvents.map((event, index) => {
            // Calculate time diff from previous event
            const timeDiff =
              index > 0 ? calculateTimeDiff(sortedEvents[index - 1]!.delta, event.delta) : null;
            const isFirstEvent = index === 0;

            // Check if this specific event is revealed
            const isRevealed = revealedIds.has(event.id);
            const shouldBlur = event.isSpoiler && !isRevealed;

            // Check if this event has a marker tag (important time moment)
            const markerTag = event.tags.find((tag: string) => tag.startsWith('marker:'));
            const markerLabel = markerTag ? markerTag.split(':')[1]?.trim() : null;

            // Convert marker label to CSS-friendly class name
            const markerClass = markerLabel
              ? `marker-${markerLabel
                  .toLowerCase()
                  .replace(/[^a-z0-9]+/g, '-')
                  .replace(/^-+|-+$/g, '')}`
              : null;

            // Build URL for revealing this event
            const newRevealSet = new Set(revealedIds);
            newRevealSet.add(event.id);
            const revealList = Array.from(newRevealSet).join(',');
            const revealUrl = buildUrl({ reveal: revealList }) + `#event-${index}`;

            const GridCard = shouldBlur ? 'div' : 'a';
            const eventUrl = `/event/${event.id}${Astro.url.search}`;
            return layout === 'grid' ? (
              // GRID LAYOUT - Compact view
              <GridCard
                href={shouldBlur ? undefined : eventUrl}
                id={`event-${index}`}
                transition:name={`event-card-${index}`}
                class:list={[
                  'bg-white rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow relative flex flex-col h-full',
                  !shouldBlur && 'cursor-pointer',
                  markerLabel ? 'border-2 border-purple-300' : 'border border-gray-200',
                  markerClass,
                ]}
              >
                {/* Event content */}
                <div
                  class:list={['flex-1', shouldBlur && 'blur-md select-none pointer-events-none']}
                >
                  <div class="flex justify-between items-start mb-2">
                    <h3 class="text-sm font-semibold text-gray-900">
                      {event.delta ? (
                        event.delta
                      ) : (
                        <span class="text-gray-400 italic">Unknown</span>
                      )}
                    </h3>
                    <span class="text-xs text-gray-500 font-mono">#{index + 1}</span>
                  </div>

                  {markerLabel && (
                    <div class="mb-2">
                      <span class="text-xs bg-purple-100 text-purple-900 px-2 py-1 rounded-full font-semibold">
                        üéØ {markerLabel}
                      </span>
                    </div>
                  )}

                  {/* First image only */}
                  {event.images && event.images.length > 0 && (
                    <div class="mb-2">
                      <img
                        src={event.images[0]}
                        alt="Event image"
                        class="w-full h-32 rounded-md object-cover"
                        loading="lazy"
                      />
                    </div>
                  )}

                  <p class="text-sm text-gray-700 mb-3 line-clamp-3">{event.text}</p>
                  <div class="flex flex-wrap gap-1">
                    {event.tags.slice(0, 3).map((tag) => (
                      <span class="bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full text-xs font-medium">
                        {tag}
                      </span>
                    ))}
                    {event.tags.length > 3 && (
                      <span class="text-xs text-gray-500">+{event.tags.length - 3}</span>
                    )}
                  </div>
                </div>

                {/* Spoiler blur overlay */}
                {shouldBlur && (
                  <div class="absolute inset-0 backdrop-blur-lg rounded-lg flex flex-col items-center justify-center z-10">
                    <div class="text-center px-4 mb-3 bg-white bg-opacity-90 p-4 rounded-lg shadow-lg">
                      <div class="text-2xl mb-1">üîí</div>
                      <p class="font-semibold text-sm mb-1 text-gray-900">Spoiler</p>
                      <p class="text-xs text-gray-700">
                        S{parseInt(getTagValue(event.tags, 'season'))}E
                        {parseInt(getTagValue(event.tags, 'episode'))}
                      </p>
                    </div>
                    <a
                      href={revealUrl}
                      class="inline-flex items-center gap-1 px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-medium text-xs cursor-pointer shadow-md"
                    >
                      <span>üëÅÔ∏è</span>
                      Reveal
                    </a>
                  </div>
                )}
              </GridCard>
            ) : (
              // LIST LAYOUT - Original detailed view
              <>
                {/* Time progression indicator */}
                {!isFirstEvent && (
                  <div class="flex items-center justify-center py-4">
                    <div class="flex-1 border-t-2 border-gray-300" />
                    <div class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">
                      {timeDiff ? `‚è±Ô∏è ${timeDiff}` : '‚è±Ô∏è some time later'}
                    </div>
                    <div class="flex-1 border-t-2 border-gray-300" />
                  </div>
                )}

                {/* First event indicator */}
                {isFirstEvent && (
                  <div class="flex items-center justify-center py-4 mb-2">
                    <div class="px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm font-semibold">
                      üìç Timeline Start {event.delta && `(${event.delta})`}
                    </div>
                  </div>
                )}

                {/* Time marker indicator */}
                {markerLabel && !isFirstEvent && (
                  <div class="flex items-center justify-center py-4 mb-2">
                    <div
                      class:list={[
                        'px-6 py-3 bg-purple-100 text-purple-900 rounded-full text-base font-bold border-2 border-purple-300 shadow-md',
                        markerClass,
                      ]}
                    >
                      üéØ {markerLabel}
                    </div>
                  </div>
                )}

                {/* Event card */}
                {(() => {
                  const ListCard = shouldBlur ? 'div' : 'a';
                  return (
                    <ListCard
                      href={shouldBlur ? undefined : eventUrl}
                      id={`event-${index}`}
                      transition:name={`event-card-${index}`}
                      class:list={[
                        'block bg-white rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow relative',
                        !shouldBlur && 'cursor-pointer',
                        markerLabel ? 'border-2 border-purple-300' : 'border border-gray-200',
                        markerClass,
                      ]}
                    >
                      {/* Event content */}
                      <div class:list={[shouldBlur && 'blur-md select-none pointer-events-none']}>
                        <div class="flex justify-between items-start mb-3">
                          <h3 class="text-xl font-semibold text-gray-900">
                            {event.delta ? (
                              event.delta
                            ) : (
                              <span class="text-gray-400 italic">Unknown time</span>
                            )}
                          </h3>
                          <span class="text-sm text-gray-500 font-mono">#{index + 1}</span>
                        </div>

                        {/* Images */}
                        {event.images && event.images.length > 0 && (
                          <div class="mb-4">
                            <div
                              class:list={[
                                'grid gap-2',
                                event.images.length === 1 ? 'grid-cols-1' : 'grid-cols-2',
                              ]}
                            >
                              {event.images.map((image) => (
                                <img
                                  src={image}
                                  alt="Event image"
                                  class="w-full h-64 rounded-md object-cover"
                                  loading="lazy"
                                />
                              ))}
                            </div>
                          </div>
                        )}

                        <p class="text-gray-700 mb-4">{event.text}</p>
                        <div class="flex flex-wrap gap-2">
                          {event.tags.map((tag) => (
                            <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-medium">
                              {tag}
                            </span>
                          ))}
                        </div>
                      </div>

                      {/* Spoiler blur overlay */}
                      {shouldBlur && (
                        <div class="absolute inset-0 backdrop-blur-lg rounded-lg flex flex-col items-center justify-center z-10">
                          <div class="text-center px-6 mb-4 bg-white bg-opacity-90 p-6 rounded-lg shadow-lg">
                            <div class="text-4xl mb-2">üîí</div>
                            <p class="font-semibold text-lg mb-1 text-gray-900">Spoiler Warning</p>
                            <p class="text-sm text-gray-700">
                              Content from Season {parseInt(getTagValue(event.tags, 'season'))},
                              Episode {parseInt(getTagValue(event.tags, 'episode'))}
                            </p>
                          </div>
                          {/* Reveal button */}
                          <a
                            href={revealUrl}
                            class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-medium text-sm cursor-pointer shadow-md"
                          >
                            <span class="text-lg">üëÅÔ∏è</span>
                            Reveal This Event
                          </a>
                        </div>
                      )}
                    </ListCard>
                  );
                })()}
              </>
            );
          })
        }
      </div>
    </main>
  </body>
</html>
