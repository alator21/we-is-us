---
// Load event data from JSON file
import eventsDataRaw from '../../data/events.json';
import { eventsDataSchema } from '../lib/eventSchema';
import Navbar from '../components/Navbar.astro';
import EventCard from '../components/EventCard.astro';
import TimeProgressionIndicator from '../components/TimeProgressionIndicator.astro';
import FirstEventIndicator from '../components/FirstEventIndicator.astro';
import MarkerIndicator from '../components/MarkerIndicator.astro';
import FilterBanner from '../components/FilterBanner.astro';
import LayoutToggle from '../components/LayoutToggle.astro';
import { parseFilterParams, hasFilterParams } from '../lib/urlParams';
import { sortEventsByDelta, calculateTimeDiff } from '../lib/deltaParser';
import { ClientRouter } from 'astro:transitions';
import '../styles/global.css';

// Parse and validate event data through Zod schema
const eventsData = eventsDataSchema.parse(eventsDataRaw);

// Helper function to extract episode/season from tags
function getTagValue(tags: string[], key: string): string {
  const tag = tags.find((t) => t.startsWith(`${key}:`));
  return tag ? tag.split(':')[1] || '1' : '1';
}

// Parse and validate filter params from URL
const filterParams = parseFilterParams(Astro.url.searchParams);
const hasFilter = hasFilterParams(Astro.url.searchParams);

// Redirect to filter page if no params
if (!hasFilter) {
  return Astro.redirect('/filter');
}

// Extract validated values
const showAll = filterParams.showAll;
const maxSeason = showAll ? 999 : filterParams.season || 0;
const maxEpisode = showAll ? 999 : filterParams.episode || 0;
const layout = filterParams.layout;

// Get list of revealed event IDs from validated params
const revealedIds = new Set(filterParams.reveal || []);

// Helper to build URL with current params
function buildUrl(overrides: Record<string, string> = {}): string {
  const params = new URLSearchParams();
  if (showAll) {
    params.set('showAll', 'true');
  } else {
    params.set('season', maxSeason.toString());
    params.set('episode', maxEpisode.toString());
  }
  if (revealedIds.size > 0) {
    params.set('reveal', Array.from(revealedIds).join(','));
  }
  params.set('layout', layout);

  // Apply overrides
  Object.entries(overrides).forEach(([key, value]) => {
    params.set(key, value);
  });

  return `/?${params.toString()}`;
}

// Mark events as spoilers based on user's progress
const eventsWithSpoilerFlag = eventsData.events.map((event) => {
  if (showAll) {
    return { ...event, isSpoiler: false };
  }

  const eventSeason = parseInt(getTagValue(event.tags, 'season'));
  const eventEpisode = parseInt(getTagValue(event.tags, 'episode'));

  const isSpoiler = !(
    eventSeason < maxSeason ||
    (eventSeason === maxSeason && eventEpisode <= maxEpisode)
  );

  return { ...event, isSpoiler };
});

// Sort events chronologically by delta
const sortedEvents = sortEventsByDelta(eventsWithSpoilerFlag);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>We Is Us - Timeline Viewer</title>
    <ClientRouter />
  </head>
  <body class="min-h-screen bg-gray-50">
    <Navbar />

    <!-- Main Content -->
    <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Page Header -->
      <div class="mb-8 flex justify-between items-center">
        <div>
          <h2 class="text-3xl font-bold text-gray-900 mb-2">Timeline</h2>
        </div>
        <div class="flex items-center gap-3">
          <LayoutToggle layout={layout} buildUrl={buildUrl} />
          <a
            href="/filter"
            class="px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-700 border border-blue-600 rounded-md hover:bg-blue-50 transition-colors"
          >
            Change Filter
          </a>
        </div>
      </div>

      <FilterBanner showAll={showAll} maxSeason={maxSeason} maxEpisode={maxEpisode} />

      <!-- Events List -->
      <div
        class:list={[
          layout === 'grid'
            ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4'
            : 'flex flex-col',
        ]}
      >
        {
          sortedEvents.map((event, index) => {
            // Calculate time diff from previous event
            const timeDiff =
              index > 0 ? calculateTimeDiff(sortedEvents[index - 1]!.delta, event.delta) : null;
            const isFirstEvent = index === 0;

            // Check if this specific event is revealed
            const isRevealed = revealedIds.has(event.id);
            const shouldBlur = event.isSpoiler && !isRevealed;

            // Check if this event has a marker tag (important time moment)
            const markerTag = event.tags.find((tag: string) => tag.startsWith('marker:'));
            const markerLabel = markerTag ? markerTag.split(':')[1]?.trim() : null;

            // Convert marker label to CSS-friendly class name
            const markerClass = markerLabel
              ? `marker-${markerLabel
                  .toLowerCase()
                  .replace(/[^a-z0-9]+/g, '-')
                  .replace(/^-+|-+$/g, '')}`
              : null;

            // Build URL for revealing this event
            const newRevealSet = new Set(revealedIds);
            newRevealSet.add(event.id);
            const revealList = Array.from(newRevealSet).join(',');
            const revealUrl = buildUrl({ reveal: revealList }) + `#event-${index}`;

            const eventUrl = `/event/${event.id}${Astro.url.search}`;

            return (
              <>
                {/* Time progression indicator (list view only) */}
                {layout === 'list' && !isFirstEvent && (
                  <TimeProgressionIndicator timeDiff={timeDiff} />
                )}

                {/* First event indicator (list view only) */}
                {layout === 'list' && isFirstEvent && <FirstEventIndicator delta={event.delta} />}

                {/* Time marker indicator (list view only) */}
                {layout === 'list' && markerLabel && !isFirstEvent && (
                  <MarkerIndicator markerLabel={markerLabel} markerClass={markerClass} />
                )}

                {/* Event card */}
                <EventCard
                  event={event}
                  index={index}
                  layout={layout}
                  shouldBlur={shouldBlur}
                  eventUrl={eventUrl}
                  revealUrl={revealUrl}
                  markerLabel={markerLabel}
                  markerClass={markerClass}
                />
              </>
            );
          })
        }
      </div>
    </main>
  </body>
</html>
