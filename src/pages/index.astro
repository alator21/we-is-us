---
// Load event data from JSON file
import eventsData from '../../data/events.json';
import Navbar from '../components/Navbar.astro';
import { parseFilterParams, hasFilterParams } from '../lib/urlParams';
import { sortEventsByDelta, calculateTimeDiff } from '../lib/deltaParser';
import { ClientRouter } from 'astro:transitions';
import '../styles/global.css';

// Helper function to extract episode/season from tags
function getTagValue(tags: string[], key: string): string {
  const tag = tags.find((t) => t.startsWith(`${key}:`));
  return tag ? tag.split(':')[1] || '1' : '1';
}

// Parse and validate filter params from URL
const filterParams = parseFilterParams(Astro.url.searchParams);
const hasFilter = hasFilterParams(Astro.url.searchParams);

// Redirect to filter page if no params
if (!hasFilter) {
  return Astro.redirect('/filter');
}

// Extract validated values
const showAll = filterParams.showAll;
const maxSeason = showAll ? 999 : filterParams.season || 0;
const maxEpisode = showAll ? 999 : filterParams.episode || 0;

// Get list of revealed event indices from validated params
const revealedIndices = new Set(filterParams.reveal || []);

// Mark events as spoilers based on user's progress
const eventsWithSpoilerFlag = eventsData.events.map((event) => {
  if (showAll) {
    return { ...event, isSpoiler: false };
  }

  const eventSeason = parseInt(getTagValue(event.tags, 'season'));
  const eventEpisode = parseInt(getTagValue(event.tags, 'episode'));

  const isSpoiler = !(
    eventSeason < maxSeason ||
    (eventSeason === maxSeason && eventEpisode <= maxEpisode)
  );

  return { ...event, isSpoiler };
});

// Sort events chronologically by delta
const sortedEvents = sortEventsByDelta(eventsWithSpoilerFlag);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>We Is Us - Timeline Viewer</title>
    <ClientRouter />
  </head>
  <body class="min-h-screen bg-gray-50">
    <Navbar />

    <!-- Main Content -->
    <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Page Header -->
      <div class="mb-8 flex justify-between items-center">
        <div>
          <h2 class="text-3xl font-bold text-gray-900 mb-2">Timeline</h2>
        </div>
        <a
          href="/filter"
          class="px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-700 border border-blue-600 rounded-md hover:bg-blue-50 transition-colors"
        >
          Change Filter
        </a>
      </div>

      <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-sm text-blue-800">
          {
            showAll
              ? 'Showing all events (no spoiler protection)'
              : `Spoiler protection active: Events beyond Season ${maxSeason}, Episode ${maxEpisode} are blurred`
          }
        </p>
      </div>

      <!-- Events List -->
      <div class="flex flex-col">
        {
          sortedEvents.map((event, index) => {
            // Calculate time diff from previous event
            const timeDiff =
              index > 0 ? calculateTimeDiff(sortedEvents[index - 1]!.delta, event.delta) : null;
            const isFirstEvent = index === 0;

            // Check if this specific event is revealed
            const isRevealed = revealedIndices.has(index);
            const shouldBlur = event.isSpoiler && !isRevealed;

            // Build URL for revealing this event
            const newRevealSet = new Set(revealedIndices);
            newRevealSet.add(index);
            const revealList = Array.from(newRevealSet)
              .sort((a, b) => a - b)
              .join(',');

            // Manually construct URL with all current params plus reveal
            let revealUrl = '/?';
            if (showAll) {
              revealUrl += 'showAll=true';
            } else {
              revealUrl += `season=${maxSeason}&episode=${maxEpisode}`;
            }
            revealUrl += `&reveal=${revealList}#event-${index}`;

            return (
              <>
                {/* Time progression indicator */}
                {!isFirstEvent && (
                  <div class="flex items-center justify-center py-4">
                    <div class="flex-1 border-t-2 border-gray-300" />
                    <div class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">
                      {timeDiff ? `‚è±Ô∏è ${timeDiff}` : '‚è±Ô∏è some time later'}
                    </div>
                    <div class="flex-1 border-t-2 border-gray-300" />
                  </div>
                )}

                {/* First event indicator */}
                {isFirstEvent && (
                  <div class="flex items-center justify-center py-4 mb-2">
                    <div class="px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm font-semibold">
                      üìç Timeline Start {event.delta && `(${event.delta})`}
                    </div>
                  </div>
                )}

                {/* Event card */}
                <div
                  id={`event-${index}`}
                  class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow relative"
                >
                  {/* Event content */}
                  <div class:list={[shouldBlur && 'blur-md select-none pointer-events-none']}>
                    <div class="flex justify-between items-start mb-3">
                      <h3 class="text-xl font-semibold text-gray-900">
                        {event.delta ? (
                          event.delta
                        ) : (
                          <span class="text-gray-400 italic">Unknown time</span>
                        )}
                      </h3>
                      <span class="text-sm text-gray-500 font-mono">#{index + 1}</span>
                    </div>

                    {/* Images */}
                    {event.images && event.images.length > 0 && (
                      <div class="mb-4">
                        <div
                          class:list={[
                            'grid gap-2',
                            event.images.length === 1 ? 'grid-cols-1' : 'grid-cols-2',
                          ]}
                        >
                          {event.images.map((image) => (
                            <img
                              src={image}
                              alt="Event image"
                              class="w-full h-64 rounded-md object-cover"
                              loading="lazy"
                            />
                          ))}
                        </div>
                      </div>
                    )}

                    <p class="text-gray-700 mb-4">{event.text}</p>
                    <div class="flex flex-wrap gap-2">
                      {event.tags.map((tag) => (
                        <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-medium">
                          {tag}
                        </span>
                      ))}
                    </div>
                  </div>

                  {/* Spoiler blur overlay */}
                  {shouldBlur && (
                    <div class="absolute inset-0 backdrop-blur-lg rounded-lg flex flex-col items-center justify-center z-10">
                      <div class="text-center px-6 mb-4 bg-white bg-opacity-90 p-6 rounded-lg shadow-lg">
                        <div class="text-4xl mb-2">üîí</div>
                        <p class="font-semibold text-lg mb-1 text-gray-900">Spoiler Warning</p>
                        <p class="text-sm text-gray-700">
                          Content from Season {parseInt(getTagValue(event.tags, 'season'))}, Episode{' '}
                          {parseInt(getTagValue(event.tags, 'episode'))}
                        </p>
                      </div>
                      {/* Reveal button */}
                      <a
                        href={revealUrl}
                        class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-medium text-sm cursor-pointer shadow-md"
                      >
                        <span class="text-lg">üëÅÔ∏è</span>
                        Reveal This Event
                      </a>
                    </div>
                  )}
                </div>
              </>
            );
          })
        }
      </div>
    </main>
  </body>
</html>
